<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="对齐支持数据对齐回忆一个经典案例： 12345678910111213141516171819202122232425struct HowManyBytes&amp;#123;    char a;    int b;&amp;#125;;int main()&amp;#123;    cout&lt;&lt;&quot;sizeof(char):&quot;&lt;&lt;sizeof(char)&lt;&lt;end">
<meta property="og:type" content="article">
<meta property="og:title" content="对齐支持">
<meta property="og:url" content="http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/index.html">
<meta property="og:site_name" content="boolsatellite">
<meta property="og:description" content="对齐支持数据对齐回忆一个经典案例： 12345678910111213141516171819202122232425struct HowManyBytes&amp;#123;    char a;    int b;&amp;#125;;int main()&amp;#123;    cout&lt;&lt;&quot;sizeof(char):&quot;&lt;&lt;sizeof(char)&lt;&lt;end">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-22T16:00:00.000Z">
<meta property="article:modified_time" content="2023-05-22T16:00:00.000Z">
<meta property="article:author" content="boolsatellite">
<meta property="article:tag" content="c++11">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>对齐支持</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="boolsatellite" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/boolsatellite">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/06/09/%E5%B8%B8%E7%94%A8%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/05/20/%E5%8F%98%E9%95%BF%E6%A8%A1%E6%9D%BF/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&text=对齐支持"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&is_video=false&description=对齐支持"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=对齐支持&body=Check out this article: http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&name=对齐支持&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&t=对齐支持"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81"><span class="toc-number">1.</span> <span class="toc-text">对齐支持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AF%B9%E9%BD%90"><span class="toc-number">1.1.</span> <span class="toc-text">数据对齐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c-11%E7%9A%84-alignof-%E5%92%8C-alignas"><span class="toc-number">1.2.</span> <span class="toc-text">c++11的 alignof  和 alignas</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        对齐支持
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">boolsatellite</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-05-22T16:00:00.000Z" itemprop="datePublished">2023-05-23</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/c-11/" rel="tag">c++11</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="对齐支持"><a href="#对齐支持" class="headerlink" title="对齐支持"></a>对齐支持</h1><h2 id="数据对齐"><a href="#数据对齐" class="headerlink" title="数据对齐"></a>数据对齐</h2><p>回忆一个经典案例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">HowManyBytes</span>&#123;</span><br><span class="line">    <span class="type">char</span> a;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;sizeof(char):&quot;</span>&lt;&lt;<span class="built_in">sizeof</span>(<span class="type">char</span>)&lt;&lt;endl;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;sizeof(int):&quot;</span>&lt;&lt;<span class="built_in">sizeof</span>(<span class="type">int</span>)&lt;&lt;endl;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;sizeof(HowManyBytes):&quot;</span>&lt;&lt;<span class="built_in">sizeof</span>(HowManyBytes)&lt;&lt;endl;</span><br><span class="line">    cout&lt;&lt;endl;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;offset of char a:&quot;</span>&lt;&lt;<span class="built_in">offsetof</span>(HowManyBytes,a)&lt;&lt;endl;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;offset of int b:&quot;</span>&lt;&lt;<span class="built_in">offsetof</span>(HowManyBytes,b)&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#define offsetof(type,member)   //不能以标准实现，必须由编译器实现</span></span><br><span class="line"><span class="comment">宏 offsetof 会展开为 std::size_t 类型的整数常量表达式，它的值是从指定类型对象开始到它指定的子对象的字节数偏移，并包括可能有的填充位。</span></span><br><span class="line"><span class="comment">如果type不是POD类型，那么offsetof的结果是未定义的</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="built_in">sizeof</span>(<span class="type">char</span>):<span class="number">1</span></span><br><span class="line"><span class="built_in">sizeof</span>(<span class="type">int</span>):<span class="number">4</span></span><br><span class="line"><span class="built_in">sizeof</span>(HowManyBytes):<span class="number">8</span></span><br><span class="line">offset of <span class="type">char</span> a:<span class="number">0</span></span><br><span class="line">offset of <span class="type">int</span> b:<span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>可以发现成员b并不是紧跟着成员a的，这是由于C&#x2F;C++的int类型数据要求对齐到4字节，即要求int类型数据必须放在一个能够整除4的地址上，而char要求对齐到1字节。这就造成了成员a之后的3字节空间被空出， 通常我们也称因为对齐而造成的内存留空为填充数据（padding data）。在C++中，每个类型的数据除去长度等属性之外，都还有一项“被隐藏”属性，那就是对齐方式。对于每个内置或者自定义类型，都存在一 个特定的对齐方式。对齐方式通常是一个整数，它表示的是一个类型的对象存放的内存地址应满足的条件。</p>
<p>对齐的数据在读写上会有性能上的优势。比如频繁使用的数据如果与处理器的高速缓存器大小对齐，有可能提高缓存性能。而更为普遍 的，在一些平台上，不按照字对齐的数据会造成数据读取效率低下。</p>
<p>在C++语言中，我们可以通过sizeof 查询数据长度，但C++语言却没有对对齐方式有关的查询或者设定进行标准化，而语言本身又允许自定义类型、模板等诸多特性。编译器无法完全找到正确的对齐方式，这会在使用时造成困难。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ColorVector</span> &#123;</span><br><span class="line">    <span class="type">double</span> r;</span><br><span class="line">    <span class="type">double</span> g;</span><br><span class="line">    <span class="type">double</span> b;</span><br><span class="line">    <span class="type">double</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//使用C++11中的alignof来查询ColorVector的对齐方式</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;alignof(ColorVector):&quot;</span> &lt;&lt; <span class="built_in">alignof</span>(ColorVector) &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">alignof运算符：alignof(类型标识符)  返回size_t类型值</span></span><br><span class="line"><span class="comment">返回由类型标识所指示的类型的任何实例所要求的对齐字节数,该类型可以是完整对象类型、元素类型完整的数组类型或者到这些类型之一的引用类型。</span></span><br><span class="line"><span class="comment">如果类型是引用类型，那么运算符返回被引用类型的对齐要求；如果类型是数组类型，那么返回元素类型的对齐要求。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">输出：<span class="built_in">alignof</span>(ColorVector):<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到 ColorVecto 依然是对齐到8字节的地址边界上。为了能够高效地读写 ColorVector 大小的数据，我们最好能将其对齐在32字节的地址边界上。<strong>我们利用C++11新提供的修饰符alignas 来重新设定ColorVector的对齐方式</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">alignas</span>(<span class="number">32</span>)ColorVector&#123;</span><br><span class="line">    <span class="type">double</span> r;</span><br><span class="line">    <span class="type">double</span> g;</span><br><span class="line">    <span class="type">double</span> b;</span><br><span class="line">    <span class="type">double</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//使用C++11中的alignof来查询ColorVector的对齐方式</span></span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;alignof(ColorVector):&quot;</span>&lt;&lt;<span class="built_in">alignof</span>(ColorVector)&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">输出：<span class="built_in">alignof</span>(ColorVector):<span class="number">32</span></span><br></pre></td></tr></table></figure>

<p>指定数据ColorVector对齐到32字节的地址边界上，只需要声明alignas(32)即可</p>
<h2 id="c-11的-alignof-和-alignas"><a href="#c-11的-alignof-和-alignas" class="headerlink" title="c++11的 alignof  和 alignas"></a>c++11的 alignof  和 alignas</h2><p>C++11在新标准中为了支持对齐，主要引入两个关键字：操作符 alignof、对齐描述符（alignment-specifier） alignas。</p>
<p>alignof：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InComplete</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Completed</span> &#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> b;</span><br><span class="line">    <span class="keyword">auto</span> &amp;c = b;</span><br><span class="line">    <span class="type">char</span> d[<span class="number">1024</span>];</span><br><span class="line">	<span class="comment">//对内置类型和完整类型使用alignof	</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">alignof</span>(<span class="type">int</span>) &lt;&lt; endl<span class="comment">//4</span></span><br><span class="line">         &lt;&lt; <span class="built_in">alignof</span>(Completed) &lt;&lt; endl;<span class="comment">//1</span></span><br><span class="line">	<span class="comment">//对变量、引用或者数组使用alignof</span></span><br><span class="line">    cout &lt;&lt; <span class="built_in">alignof</span>(a) &lt;&lt; endl<span class="comment">//4</span></span><br><span class="line">         &lt;&lt; <span class="built_in">alignof</span>(b) &lt;&lt; endl<span class="comment">//8</span></span><br><span class="line">         &lt;&lt; <span class="built_in">alignof</span>(c) &lt;&lt; endl<span class="comment">//8，与b相同</span></span><br><span class="line">         &lt;&lt; <span class="built_in">alignof</span>(d) &lt;&lt; endl;<span class="comment">//1,与元素要求相同</span></span><br><span class="line">    <span class="comment">//cout&lt;&lt;alignof(Incomplete)&lt;&lt;endl;  本句无法通过编译，Incomplete类型不完整</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>alignas：</p>
<p>alignas 既可以接受常量表达式，也可以接受类型作为参数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alignas</span>(<span class="type">double</span>) <span class="type">char</span> c;  &lt;==&gt;  <span class="built_in">alignas</span>(<span class="built_in">alignof</span>(<span class="type">double</span>)) <span class="type">char</span> c;</span><br></pre></td></tr></table></figure>

<p>我们在使用常量表达式作为 alignas 的操作符的时候，其结果必须是以2 的自然数幂次作为对齐值。</p>
<p>对齐描述符可以作用于各种数据。具体来说，可以修饰变量、类的数据成员等，而位域（bit field），函数以及用register声明的变量则不可以。</p>
<p>采用了模板的方式来实现一个固定容量但是大小随着所用的数据类型变化的容器类型</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">alignas</span>(<span class="built_in">alignof</span>(<span class="type">double</span>) * <span class="number">4</span>)ColorVector &#123;</span><br><span class="line">    <span class="type">double</span> r;</span><br><span class="line">    <span class="type">double</span> g;</span><br><span class="line">    <span class="type">double</span> b;</span><br><span class="line">    <span class="type">double</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//固定容量的模板数组</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FixedCapacityArray</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push_back</span><span class="params">(T t)</span> </span>&#123;<span class="comment">/*在data中加入t变量*/</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//一些其他成员函数、成员变量等</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="type">char</span> <span class="title">alignas</span><span class="params">(T)</span> data[1024] </span>= &#123;<span class="number">0</span>&#125;;   <span class="comment">//根据模板参数类型指定对齐方式，且控制数组大小为1024字节</span></span><br><span class="line">	<span class="comment">//对应的数组元素个数为：length=1024/sizeof(T);</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FixedCapacityArray&lt;<span class="type">char</span>&gt; arrCh;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;alignof(char):&quot;</span> &lt;&lt; <span class="built_in">alignof</span>(<span class="type">char</span>) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;alignof(arrCh.data):&quot;</span> &lt;&lt; <span class="built_in">alignof</span>(arrCh.data) &lt;&lt; endl;</span><br><span class="line">    FixedCapacityArray&lt;ColorVector&gt; arrCV;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;alignof(ColorVector):&quot;</span> &lt;&lt; <span class="built_in">alignof</span>(ColorVector) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;alignof(arrCV.data):&quot;</span> &lt;&lt; <span class="built_in">alignof</span>(arrCV.data) &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="built_in">alignof</span>(<span class="type">char</span>):<span class="number">1</span></span><br><span class="line"><span class="built_in">alignof</span>(arrCh.data):<span class="number">1</span></span><br><span class="line"><span class="built_in">alignof</span>(ColorVector):<span class="number">32</span></span><br><span class="line"><span class="built_in">alignof</span>(arrCV.data):<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>FixedCapacityArray固定 使用1024字节的空间，但由于模板的存在，可以实例化为各种版本。这样一来，我们可以在相同的内存使用量的前提下，做出多种类型 （内置或者自定义）版本的数组。</p>
<p>在STL 库中，还内建了std::align函数来动态地根据指定的对齐方式调整数据块的位置。函数原型：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span>*</span></span><br><span class="line"><span class="function"><span class="title">align</span><span class="params">(<span class="type">size_t</span> __align, <span class="type">size_t</span> __size, <span class="type">void</span>*&amp; __ptr, <span class="type">size_t</span>&amp; __space)</span> <span class="keyword">noexcept</span></span></span><br></pre></td></tr></table></figure>

<p>该函数在 ptr 指向的大小为 space 的内存中进行对齐方式的调整，将 ptr 开始的 size大小的数据调整为按 align 对齐。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ColorVector</span> &#123;</span><br><span class="line">    <span class="type">double</span> r;</span><br><span class="line">    <span class="type">double</span> g;</span><br><span class="line">    <span class="type">double</span> b;</span><br><span class="line">    <span class="type">double</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> <span class="type">const</span> size = <span class="number">100</span>;</span><br><span class="line">    ColorVector *<span class="type">const</span> vec = <span class="keyword">new</span> ColorVector[size];</span><br><span class="line">    <span class="type">void</span> *p = vec;</span><br><span class="line">    <span class="type">size_t</span> sz = size;</span><br><span class="line">    <span class="type">void</span> *aligned = <span class="built_in">align</span>(<span class="built_in">alignof</span>(<span class="type">double</span>) * <span class="number">4</span>, size, p, sz);</span><br><span class="line">    <span class="comment">//在指针p指向的空间大小为sz的内存中，将大小为size的内存以alignof(double)*4的方式对齐</span></span><br><span class="line">    <span class="keyword">if</span> (aligned != <span class="literal">nullptr</span>)</span><br><span class="line">        cout &lt;&lt; <span class="built_in">alignof</span>(p) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c++11还提供了aligned_storage 及 aligned_union，函数原型：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>＜std::<span class="type">size_t</span> Len,std::<span class="type">size_t</span> Align=<span class="comment">/*default-alignment*/</span>＞</span><br><span class="line"><span class="keyword">struct</span> aligned_storage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>＜std::<span class="type">size_t</span> Len,<span class="keyword">class</span>...Types＞</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">aligned_union</span>;</span><br></pre></td></tr></table></figure>

<p><strong>还没有理解aligned_storage 及 aligned_union 的正确使用。</strong></p>
<p>参考：书籍《深入理解c++11》</p>
<p>内存对齐概念：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhao-zongsheng/p/9099603.html">https://www.cnblogs.com/zhao-zongsheng/p/9099603.html</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">tags</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/boolsatellite">Projects</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81"><span class="toc-number">1.</span> <span class="toc-text">对齐支持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AF%B9%E9%BD%90"><span class="toc-number">1.1.</span> <span class="toc-text">数据对齐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c-11%E7%9A%84-alignof-%E5%92%8C-alignas"><span class="toc-number">1.2.</span> <span class="toc-text">c++11的 alignof  和 alignas</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&text=对齐支持"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&is_video=false&description=对齐支持"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=对齐支持&body=Check out this article: http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&title=对齐支持"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&name=对齐支持&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/05/23/%E5%AF%B9%E9%BD%90%E6%94%AF%E6%8C%81/&t=对齐支持"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    boolsatellite
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/boolsatellite">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SPWV8NBZ00"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-SPWV8NBZ00');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
